# Deployment Guide - Annotation & Timer Fix

## Overview
This guide explains the changes made to fix annotation persistence and timer logic in the Forest PDF Viewer application.

## Issues Fixed

### 1. Timer Logic Fixed ✅
**Problem**: Timer was incrementing by 22 instead of 1 each second
**Root Cause**: Multiple timer intervals were being created due to React dependencies and lack of proper cleanup
**Solution**: 
- Added `useRef` to prevent multiple intervals
- Improved cleanup with proper timeout handling
- Fixed dependency array to prevent unnecessary recreations

### 2. Annotation Persistence Fixed ✅
**Problem**: Annotations were lost when changing browsers or restarting server
**Root Cause**: Annotations were only stored in localStorage, not in PostgreSQL database
**Solution**:
- Updated PDFViewer to use database API endpoints
- Implemented proper database storage for all annotation types
- Added fallback to localStorage for offline support

## Database Configuration

The application uses PostgreSQL with the following models:
- **Users**: User authentication and management
- **Files**: PDF file metadata
- **Annotations**: All annotation types (highlights, drawings, sticky notes, etc.)
- **PageTracking**: Reading time and progress tracking

### Environment Variables Required
```env
# Database Configuration
DB_NAME=forest_pdf_viewer_dev
DB_USER=postgres
DB_PASSWORD=your_password
DB_HOST=localhost
DB_PORT=5432
DB_SSL=false

# Application
NODE_ENV=development
PORT=3001
```

## Annotation Types Supported

The database now properly stores all annotation types:

1. **Highlights** (text-selection and click-based)
2. **AI Highlights** (generated by Gemini AI)
3. **Drawings** (freehand with color selection)
4. **Underlines** (text-selection and click-based)
5. **Sticky Notes** (with content and file attachments)
6. **Comments** (text annotations)

### Database Schema for Annotations

```sql
CREATE TABLE annotations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  file_id UUID NOT NULL REFERENCES files(id),
  page_number INTEGER NOT NULL,
  annotation_type VARCHAR(20) NOT NULL CHECK (annotation_type IN ('highlight', 'underline', 'stickynote', 'drawing', 'comment')),
  coordinates JSONB,
  content TEXT,
  selected_text TEXT,
  color VARCHAR(7) DEFAULT '#ffff00',
  attachments JSONB DEFAULT '[]',
  style_properties JSONB DEFAULT '{}',
  ai_generated BOOLEAN DEFAULT false,
  ai_metadata JSONB,
  is_text_selection BOOLEAN DEFAULT false,
  coordinate_version VARCHAR(10) DEFAULT '2.0',
  metadata JSONB DEFAULT '{}',
  is_deleted BOOLEAN DEFAULT false,
  tags VARCHAR[] DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## API Endpoints

### Annotation Management
- `POST /api/annotations` - Create new annotation
- `GET /api/annotations/file/:fileId` - Get all annotations for a file
- `GET /api/annotations/file/:fileId/page/:pageNumber` - Get annotations for specific page
- `PUT /api/annotations/:annotationId` - Update annotation
- `DELETE /api/annotations/:annotationId` - Delete annotation (soft delete)
- `POST /api/annotations/bulk` - Create multiple annotations

### Authentication Required
All annotation endpoints require authentication via JWT token in Authorization header:
```
Authorization: Bearer <your_jwt_token>
```

## Deployment Steps

### 1. Backend Setup
```bash
cd backend
npm install
```

### 2. Database Setup
```bash
# Start PostgreSQL
# Create database
createdb forest_pdf_viewer_dev

# Run migration (when server starts, it will auto-create tables)
npm run start
```

### 3. Frontend Setup
```bash
cd frontend
npm install
```

### 4. Environment Configuration
Create `.env` files in both frontend and backend directories with appropriate values.

### 5. Start Application
```bash
# Backend
cd backend && npm run dev

# Frontend
cd frontend && npm run dev
```

## Testing

### 1. Timer Functionality
- Load a PDF and navigate to any page
- Verify timer starts at 0 and increments by 1 every second
- Change pages and verify timer resets and loads previous time for returning pages
- Refresh browser and verify timer continues from where it left off

### 2. Annotation Persistence
- Create highlights, drawings, sticky notes on any page
- Refresh browser - annotations should persist
- Switch browsers - annotations should persist (database storage)
- Restart server - annotations should persist

### 3. Cross-Browser Testing
- Create annotations in Chrome
- Open same PDF in Firefox with same user account
- Verify all annotations are visible

## Troubleshooting

### Database Connection Issues
```bash
# Check if PostgreSQL is running
sudo systemctl status postgresql

# Start PostgreSQL if stopped
sudo systemctl start postgresql

# Check connection
psql -h localhost -U postgres -d forest_pdf_viewer_dev
```

### Annotation Not Saving
1. Check browser console for API errors
2. Verify JWT token is valid
3. Check backend logs for database errors
4. Ensure user has permission to file

### Timer Issues
1. Check for multiple timer intervals in browser dev tools
2. Verify localStorage contains timer data
3. Check page tracking API endpoints

## Performance Considerations

### 1. Database Indexing
The annotation table has optimized indexes for:
- User queries: `user_id`
- File queries: `file_id` 
- Page queries: `file_id, page_number`
- Type filtering: `annotation_type`

### 2. Caching Strategy
- Annotations are loaded per page to reduce memory usage
- Timer data is saved every 10 seconds to balance performance and data safety
- localStorage is used as backup for offline scenarios

### 3. Large Files
- Pagination implemented for large numbers of annotations
- Soft delete used for annotations to maintain data integrity
- Bulk operations available for importing/exporting annotations

## Security Features

1. **User Isolation**: Users can only see their own annotations
2. **File Access Control**: Annotations are tied to file ownership
3. **Input Validation**: All annotation data is validated before storage
4. **Soft Delete**: Annotations are marked as deleted rather than removed
5. **XSS Prevention**: Content is sanitized before storage and display

## Monitoring

### Health Checks
- `GET /api/health` - Application health status
- `GET /api/health/database` - Database connection status

### Logging
- All annotation operations are logged
- Failed database operations are tracked
- User authentication events are logged

## Future Enhancements

1. **Real-time Collaboration**: WebSocket support for shared annotations
2. **Annotation Search**: Full-text search across annotation content
3. **Export Features**: PDF export with annotations embedded
4. **Mobile Support**: Touch-optimized annotation tools
5. **AI Improvements**: Better AI suggestion accuracy and categorization